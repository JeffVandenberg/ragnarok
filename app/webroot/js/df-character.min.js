function updateSkills(){var e=dfCharacter.baseMentalStress;var t=dfCharacter.basePhysicalStress;var n=dfCharacter.baseSocialStress;var r=0;var i=0;var s=0;$(".skill-name").each(function(o,u){var a=$(u).parent("div").find(".skill-level").val();var f=$("#CharacterPhysicalStressSkillId").find("option:selected").text();var l=$("#CharacterMentalStressSkillId").find("option:selected").text();var c=$("#CharacterSocialStressSkillId").find("option:selected").text();if($(u).val()===l){e+=dfCharacter.calculateStressModifier(a);r=dfCharacter.calculateExtraConsequence(a)}if($(u).val()==="Discipline"){}if($(u).val()===f){t+=dfCharacter.calculateStressModifier(a);i=dfCharacter.calculateExtraConsequence(a)}if($(u).val()===c){n+=dfCharacter.calculateStressModifier(a);s=dfCharacter.calculateExtraConsequence(a)}});$("#mental-stress").html(e);$("#extra-mental-consequences").html(r);$("#physical-stress").html(t);$("#extra-physical-consequences").html(i);$("#social-stress").html(n);$("#extra-social-consequences").html(s)}function initializeCharacter(){updateSkills()}function clearPowerRow(){$(this).closest("div").find(".power-id").val(0);$(this).closest("div").find(".refresh-cost").val("0");$(this).closest("div").find(".power-note").val("").blur();$(this).closest("div").find(".power-name").unlockField().val("").blur();checkRefresh()}function clearSkillRow(){$(this).closest("div").find(".skill-id").val(0);$(this).closest("div").find(".skill-level").val("0");$(this).closest("div").find(".skill-name").unlockField().val("").blur();checkSkills()}function clearStuntRow(){$(this).closest("div").find(".stunt-id").val(0);$(this).closest("div").find(".stunt-cost").val("0");$(this).closest("div").find(".stunt-note").val("").blur();$(this).closest("div").find(".stunt-name").unlockField().val("").blur();checkSkills()}function checkSkills(){var e=dfCharacter.skillPoints;var t=[0,0,0,0,0,0,0,0];$(".skill-level").each(function(e,n){if(!isNaN(parseInt($(n).val()))){t[$(n).val()]=t[$(n).val()]+1}else{}}).each(function(n,r){if(!isNaN(parseInt($(r).val()))){if($(r).val()!=1&&t[$(r).val()]>t[$(r).val()-1]){$(this).css("background-color","#ccbbbb")}else{$(this).css("background-color","")}e=e-$(this).val()}else{$(this).css("background-color","")}});$("#skill-points").val(e)}function checkRefresh(){var e=dfCharacter.powerLevel;var t=false;$(".refresh-cost").each(function(n,r){var i=$(r).closest("div").find(".power-id").val();if(i!="0"&&i!=""){t=true}if(!isNaN(parseInt($(r).val()))){e+=parseInt($(r).val())}});$(".stunt-cost").each(function(t,n){if(!isNaN(parseInt($(n).val()))){e+=parseInt($(n).val())}});if(!t){$("#CharacterTemplateId").val("1");e+=2}else{if($("#CharacterTemplateId").val()=="1"){alert("No longer a mortal character. Please change template.")}}$("#CharacterMaxFate").val(e)}function sortSkills(){var e=[];var t=$("#skill-list");t.find("li").each(function(){var t={};t.id=$(this).find(".skill-id").val();t.skill=$(this).find(".skill-name").getValue();t.level=$(this).find(".skill-level").val();e.push(t)});e.sort(function(e,t){if(e.level>t.level){return-1}if(t.level>e.level){return 1}return(e.skill||"|||").toUpperCase().localeCompare((t.skill||"|||").toUpperCase())});var n=0;t.find("li").each(function(t,r){$(r).find(".skill-id").val(e[n].id);$(r).find(".skill-name").val(e[n].skill).blur();$(r).find(".skill-level").val(e[n].level);n++});checkSkills();updateSkillElements()}function updateSkillElements(){$("#skill-list").find("li").each(function(){if(parseInt($(this).find(".skill-id").val())>0){$(this).find(".skill-name").lockField();if($(this).find(".skill-delete").length==0){$(this).find("div").appendDelete("skill-delete")}}else{$(this).find(".skill-name").unlockField();$(this).find(".skill-delete").remove()}})}function updateStuntElements(){$("#stunt-list").find("li").each(function(){if(parseInt($(this).find(".stunt-id").val())>0){$(this).find(".stunt-name").lockField();if($(this).find(".stunt-delete").length==0){$(this).find("div").appendDelete("stunt-delete")}}else{$(this).find(".stunt-name").unlockField();$(this).find(".stunt-delete").remove()}})}function updatePowerElements(){$("#power-list").find("li").each(function(){if(parseInt($(this).find(".power-id").val())>0){$(this).find(".power-name").lockField();if($(this).find(".power-delete").length==0){$(this).find("div").appendDelete("power-delete")}}else{$(this).find(".power-name").unlockField();$(this).find(".power-delete").remove()}})}var dfCharacter={};dfCharacter.skillPoints=30;dfCharacter.powerLevel=8;dfCharacter.baseMentalStress=2;dfCharacter.basePhysicalStress=2;dfCharacter.baseSocialStress=2;dfCharacter.calculateStressModifier=function(e){var t=0;if(e>=1&&e<=2){t=1}if(e>=3){t=2}return t};dfCharacter.calculateExtraConsequence=function(e){var t=0;if(e>4){t=Math.ceil((e-4)/2)}return t};$(function(){initializeCharacter();$(".simple-button").button();var e=true;var t;$(document).on("focus",".skill-name:not(.ui-autocomplete-input)",function(){$(this).autocomplete({source:baseUrl+"skills/getList.json",select:function(e,n){t=true;$(this).closest("div").find(".skill-name").val(n.item.label).lockField();$(this).closest("div").find(".skill-id").val(n.item.value);$(this).closest("div").appendDelete("skill-delete");e.preventDefault()},response:function(){t=false},focus:function(){return false},change:function(){var n=$(this).closest("div").find(".skill-name").val();if(!t&&n!=""&&n!="Skill Name"){if(e){alert("Please select a skill from the list rather than free type.");e=false}$(this).closest("div").find(".skill-name").val("").blur();$(this).closest("div").find(".skill-id").val(0)}}});$(this).autocomplete("search",$(this).val())});dfCharacter.selectedStunt=false;$(document).on("focus",".stunt-name:not(.ui-autocomplete-input)",function(){$(this).autocomplete({source:baseUrl+"stunts/getList.json",focus:function(){return false},select:function(e,t){dfCharacter.selectedStunt=true;$(this).closest("div").find(".stunt-name").val(t.item.label).lockField();$(this).closest("div").find(".stunt-id").val(t.item.value);$(this).closest("div").find(".stunt-cost").val(t.item.Stunt.cost);$(this).closest("div").appendDelete("stunt-delete");e.preventDefault()},response:function(e,t){dfCharacter.selectedStunt=false;dfCharacter.inStunt=false;for(var n=0;n<t.content.length;n++){var r=t.content[n];r.label=r.Stunt.stunt_name+" ("+r.Skill.skill_name+")";r.value=r.Stunt.id}},change:function(){dfCharacter.inStunt=true;var e=$(this).closest("div");var t=$(e).find(".stunt-name").val();if(!dfCharacter.selectedStunt&&t!="Stunt Name"&&t!=""){if(confirm("Would you like to create "+t+"?")){$("#sheet-subview").load(baseUrl+"stunts/add?name="+encodeURIComponent(t),null,function(){$(this).dialog({modal:true,width:600,height:550,title:"Add Stunt",closeOnEscape:false,open:function(){$(".ui-dialog-titlebar-close").hide()},buttons:{Save:function(){var t=this;var n=$("#sheet-subview").find("form").serializeArray();$.post(baseUrl+"stunts/add/",n,function(n){if(n.result=="ok"){$(e).find(".stunt-name").val(n.Stunt.stunt_name).lockField();$(e).find(".stunt-id").val(n.Stunt.id);$(this).closest("div").appendDelete("stunt-delete");$(t).dialog("close")}else{alert(n.message)}})},Cancel:function(){$(e).find(".stunt-name").val("").blur();$(this).dialog("close")}}})})}else{$(this).closest("div").find(".stunt-name").val("").blur();$(this).closest("div").find(".stunt-id").val(0)}}}});$(this).autocomplete("search",$(this).val())});dfCharacter.selectedPower=false;$(document).on("focus",".power-name:not(.ui-autocomplete-input)",function(){$(this).autocomplete({source:baseUrl+"powers/getList.json",select:function(e,t){dfCharacter.selectedPower=true;$(this).closest("div").find(".power-name").val($.trim(t.item.label)).lockField();$(this).closest("div").find(".power-id").val(t.item.value);$(this).closest("div").find(".refresh-cost").val(t.item.Power.cost);$(this).closest("div").appendDelete("power-delete");checkRefresh();e.preventDefault()},response:function(e,t){dfCharacter.selectedPower=false;for(var n=0;n<t.content.length;n++){var r=t.content[n];r.label=$.trim(r.Power.power_name);r.value=r.Power.id}},focus:function(){return false},change:function(){var e=$(this).closest("div").find(".power-name").val();var t=$(this).closest("div").find(".power-id").val();if(t==""||t=="0"){if($.trim(e)!="Power Name"&&$.trim(e)!=""){alert("Select Powers from the drop down");$(this).closest("div").find(".power-name").val("").blur()}}dfCharacter.selectedPower=false}});$(this).autocomplete("search",$(this).val())});$("#add-skill").click(function(){var e=$("#skill-list");var t=e.find("li").length;var n=$("<li></li>");var r=$("<div></div>").addClass("input");var i=$("<input />").attr("type","hidden").attr("name","data[Character]["+t+"][CharacterSkill][id]").attr("id","Character"+t+"CharacterSkillId");var s=$("<input />").attr("type","hidden").attr("name","data[Character]["+t+"][CharacterSkill][skill_id]").attr("id","Character"+t+"CharacterSkillSkillId").addClass("skill-id").val(0);var o=$("<input />").addClass("skill-name").addClass("field-hint").attr("fieldname","Skill Name").attr("name","data[Character]["+t+"][CharacterSkill][skill_name]").val("");var u=$("<input />").addClass("skill-level").attr("type","number").attr("name","data[Character]["+t+"][CharacterSkill][skill_level]").val(0);var a=$("<img />").attr("src",baseUrl+"img/ragny_icon_search.png").addClass("skill-view").addClass("clickable");n.append(r.append(i).append(s).append(o).append(u).append(a));e.append(n);o.blur()});$("#add-power").click(function(){var e=$("#power-list");var t=e.find("li").length;var n=$("<li></li>");var r=$("<div></div>").addClass("input");var i=$("<input />").attr("type","hidden").attr("name","data[CharacterPower]["+t+"][id]").attr("id","CharacterPower"+t+"Id");var s=$("<input />").attr("type","hidden").attr("name","data[CharacterPower]["+t+"][power_id]").attr("id","CharacterPower"+t+"PowerId").addClass("power-id").val(0);var o=$("<input />").addClass("power-name").addClass("field-hint").attr("fieldname","Power Name").attr("name","data[CharacterPower]["+t+"][Power][power_name]").attr("id","CharacterPower"+t+"PowerPowerName");var u=$("<input />").addClass("power-note").addClass("field-hint").attr("fieldname","Power Note").attr("name","data[CharacterPower]["+t+"][power_note]").attr("id","CharacterPower"+t+"PowerNote");var a=$("<input />").addClass("refresh-cost").attr("type","number").attr("name","data[CharacterPower]["+t+"][refresh_cost]").val(0);var f=$("<img />").attr("src",baseUrl+"img/ragny_icon_search.png").addClass("power-view").addClass("clickable");n.append(r.append(i).append(s).append(o).append(u).append(a).append(f));e.append(n);o.blur();u.blur()});$("#add-stunt").click(function(){var e=$("#stunt-list");var t=e.find("li").length;var n=$("<li></li>");var r=$("<div></div>").addClass("input");var i=$("<input />").attr("type","hidden").attr("name","data[CharacterStunt]["+t+"][id]").attr("id","CharacterStunt"+t+"Id");var s=$("<input />").attr("type","hidden").attr("name","data[CharacterStunt]["+t+"][stunt_id]").attr("id","CharacterStunt"+t+"StuntId").addClass("stunt-id").val("0");var o=$("<input />").addClass("stunt-name").addClass("field-hint").attr("fieldname","Stunt Name").attr("name","stunt_name[]").val("Stunt Name").css("color","#aaaaaa");var u=$("<input />").addClass("stunt-note").addClass("field-hint").attr("fieldname","Note").attr("name","data[CharacterStunt]["+t+"][note]").attr("id","CharacterStunt"+t+"Note").attr("type","text").attr("maxlength",45).val("Note").css("color","#aaaaaa");var a=$("<input />").addClass("stunt-cost").attr("name","data[CharacterStunt]["+t+"][cost]").attr("id","CharacterStunt"+t+"Cost").attr("type","hidden").val(0);var f=$("<img />").attr("src",baseUrl+"img/ragny_icon_search.png").addClass("stunt-view").addClass("clickable");n.append(r.append(i).append(s).append(o).append(u).append(a).append(f));e.append(n)});$("#apply-template").click(function(){alert("applying template")});$("#sort-skills").click(function(){sortSkills()});$("#sort-powers").click(function(){var e=[];var t=$("#power-list");t.find("li").each(function(){var t={};t.id=$(this).find(".power-id").val();t.name=$(this).find(".power-name").getValue();t.note=$(this).find(".power-note").getValue();t.cost=$(this).find(".refresh-cost").val();e.push(t)});e.sort(function(e,t){console.debug("compare "+e.name+" to "+t.name);if((e.name||"|||")=="|||"){return 1}if((t.name||"|||")=="|||"){return-1}return(e.name||"|||").toUpperCase().localeCompare((t.name||"|||").toUpperCase())});var n=0;t.find("li").each(function(t,r){$(r).find(".power-id").val(e[n].id);$(r).find(".power-name").val(e[n].name).blur();$(r).find(".power-note").val(e[n].note).blur();$(r).find(".refresh-cost").val(e[n].cost);n++});updatePowerElements()});$("#sort-stunts").click(function(){var e=[];var t=$("#stunt-list");t.find("li").each(function(){var t={};t.id=$(this).find(".stunt-id").val();t.name=$(this).find(".stunt-name").getValue();t.note=$(this).find(".stunt-note").getValue();t.cost=$(this).find(".stunt-cost").val();e.push(t)});e.sort(function(e,t){if((e.name||"|||")=="|||"){return 1}if((t.name||"|||")=="|||"){return-1}return(e.name||"|||").toUpperCase().localeCompare((t.name||"|||").toUpperCase())});var n=0;t.find("li").each(function(t,r){$(r).find(".stunt-name").val(e[n].name).blur();$(r).find(".stunt-id").val(e[n].id);$(r).find(".stunt-note").val(e[n].note).blur();$(r).find(".stunt-cost").val(e[n].cost);n++});updateStuntElements()});$("#CharacterSkillSpread").change(function(){$(".skill-id").val(0);$(".skill-level").val(0);$(".skill-name").val("").blur();var e=$(this).find(":selected").text();var t=0;var n=1;while(e!=""){var r=e.lastIndexOf("/");var i=e.substring(r+1);for(var s=0;s<i;s++){$("#CharacterSkill"+t++ +"SkillLevel").val(n)}e=e.substring(0,r);n++}sortSkills()});$(document).on("click",".skill-view",function(){var e=$(this).closest("div").find(".skill-id").val();if(e==0||e==""){alert("No Skill to display")}else{$("#sheet-subview").load(baseUrl+"skills/view/"+e,null,function(){$(this).dialog({modal:true,width:500,height:400,title:"View Skill"})})}});$(document).on("click",".stunt-view",function(){var e=$(this).closest("div").find(".stunt-id").val();if(e==0||e==""){alert("No Stunt to display")}else{$("#sheet-subview").load(baseUrl+"stunts/view/"+e,null,function(){$(this).dialog({modal:true,width:500,height:400,title:"View Stunt"})})}});$(document).on("click",".power-view",function(){var e=$(this).closest("div").find(".power-id").val();if(e==0||e==""){alert("No Power to display")}else{$("#sheet-subview").load(baseUrl+"powers/view/"+e,null,function(){$(this).dialog({modal:true,width:500,height:400,title:"View Power"})})}});$(document).off("blur",".skill-level").on("blur",".skill-level",function(){checkSkills();updateSkills()});$(document).off("blur",".refresh-cost").on("blur",".refresh-cost",function(){checkRefresh()});$(document).off("click",".skill-delete").on("click",".skill-delete",function(){var e=$(this).closest("div").find(".skill-name").val();if(confirm("Are you sure you want to delete "+e+"?")){clearSkillRow.call(this);$(this).remove()}});$(document).off("click",".stunt-delete").on("click",".stunt-delete",function(){var e=$(this).closest("div").find(".stunt-name").val();if(confirm("Are you sure you want to delete "+e+"?")){clearStuntRow.call(this);$(this).remove()}});$(document).off("click",".power-delete").on("click",".power-delete",function(){var e=$(this).closest("div").find(".power-name").val();if(confirm("Are you sure you want to delete "+e+"?")){clearPowerRow.call(this);$(this).remove()}})});$.fn.lockField=function(){$(this).css("background-color","#ddccbb").attr("readonly","readonly");return $(this)};$.fn.unlockField=function(){$(this).css("background-color","").attr("readonly",false);return $(this)};$.fn.appendDelete=function(e){$(this).append($("<img />").addClass(e).addClass("clickable").attr("src",baseUrl+"img/ragny_icon_delete.png"));return $(this)}